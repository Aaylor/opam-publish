# opam-publish

A tool to ease contributions to opam repositories.

## Preliminary specification

Performs in two steps: `prepare` and `submit`

1. gather the metadata (NEED: archive url, opt. source dir, opt. repo if the package exists with the same or an earlier version)
   - [x] opam file, descr and additional stuff in files/ from the archive or source
   - [ ] same metadata from the repo
   - [x] url file (generate from archive url) (options we may add later: if on github, work with releases; provide hosting)

   Simplest: just generate a directory with the gathered stuff, and let the user edit the directory, then run a command we specified to get to step 2;
2. submit (NEED: opam repository, user credentials for github)
   - [x] start from a directory generated by the step above
   - [x] perform sanity checks on it
   - [x] clone or update opam-repository to somewhere local (--depth 1 should be ok)
   - [ ] check repo version
   - [x] add/replace package dir from above to packages/<pkgname>/<pkgname.pkgversion>
   - [x] commit the change
   - [ ] GENERIC WAY: `git format-patch` and send that to the repo manager
   - [ ] GITHUB WAY: doesn't there exist any "format-patch to PR" gateway ?
     - [x] make sure the user has a fork
     - [x] force push to branch opam-publish/pkgname.pkgversion of user_fork
     - [x] pull-request if no pull-request is open yet
     - [ ] link the user to the tracking page
3. amend
   - [ ] similar to step 1. except the dir is fetched from user_fork/opam-publish/branch.
       we may want to keep that data somewhere ?
   - [x] then you can proceed to step 2 again. It will squash all patches, but otherwise git just gets too complicated.


## Current state

- prepare and submit both work
- prepare only gets the data from the archive (so no step 3.)
- publish does limited checks on what is submitted
- github interface is _very_ dumb, just a curl request, will ask for name/password every time, doesn't check return values
- no format-patch interface
